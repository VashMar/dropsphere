- var nicknames = data.nicknames;
- var sphereIDs = data.sphereIDs;
- var currentSphere = data.currentSphere;
- var feed = data.feed; 
- var posts = data.posts; 
- var announcements = Object.keys(data.announcements);
- var sphereMap = data.sphereMap;
- var contacts = data.contacts;
- var contactIds = Object.keys(contacts);
- var requests = data.requests;
- var requesterIds = Object.keys(requests);
- var newRequests = data.newRequests;
#container
    #chat
        .dropdown
            #navButtons 
                a#settings(data-toggle="dropdown" href="#")
                ul.dropdown-menu(role="menu" aria-labelledby="dLabel")
                    li(role="presentation" class="dropdown-header") Profile Settings
                    li(role="presentation")
                        a(role="menuitem" tabindex="-1" data-toggle="modal" data-target="#nickChange" href="#") Set Nickname(s) 
                    li(role="presentation" class="divider")
                    li(role="presentation")
                        a(role="menuitem" tabindex="-1" href="#" onclick="logout();") Logout 
                a#contacts(data-toggle="modal" data-target="#contactList")
                if newRequests > 0
                    span#newRequests
                        p 
                            =newRequests
                else
                    span#newRequests(style="display:none;")
        img#chatLogo(src="/img/dropsphere_sm.png")
        .dropdown
            a#currentInfo.btn.btn-primary( data-toggle="dropdown" href="#")
                span#notifications.badge.badge-success
                span#currentSphere
                    =sphereMap[currentSphere].name 
                    span.caret 
            ul#sphereList.dropdown-menu(role="menu" aria-labelledby="dLabel")
                li.dropdown-header(role="presentation") My Spheres
                li(role="presentation" id="sphereNames")
                    each sphereID, i in sphereIDs 
                        - var updates = sphereMap[sphereID].updates;
                        - var sphereName = sphereMap[sphereID].name;
                        a(class = "sphere" data=sphereID role="menuitem" tabindex="-1" data-toggle="modal" href="#")
                            if updates > 0
                                span.sphereUpdates(id="updates-" + i)
                                    =updates
                                &nbsp;
                            else
                                span(id ="okcircle-" + i class="glyphicon glyphicon-ok-circle") 
                                &nbsp;
                            span.sphereName
                                =sphereName
                li#sphereDivider.divider(role="presentation" )
                li(role="presentation")
                    a#sphereCreate(role="menuitem" tabindex="-1" data-toggle="modal" data-target="#sphereDialog" href="#") <span class="glyphicon glyphicon-plus-sign"></span> Create Sphere
                li(role="presentation")
                    a#sphereDelete(role="menuitem" tabindex="-1" data-toggle="modal" data-target="#deleteSphere" href="#") <span class="glyphicon glyphicon-minus-sign"></span> Delete Sphere
        audio#notifySound(src="/sounds/waterDrop.ogg" preload="auto")
        #users 
            if sphereMap[currentSphere].type === "Group"
                a#share_small(data-toggle="modal" data-target="#shareModal")
            each nickname in nicknames
                p=nickname
        #content(class="form-control")
            .postBox
                 textarea#urlInput(class="form-control" placeholder="URL goes here...")
                 textarea#postInput(class="form-control" maxlength="140" placeholder="Enter a message...")
                 #previewContainer(style="display:none")
                    a#closePreview(href="#" onclick="closePreview();")
                        img(src="/img/close_preview.png")
                    #previewLink(class="post")
                 input#drop(type='button' class="btn btn-primary" value='drop' onclick='getLink();')
                 input#post(type='button' class="btn btn-primary" value='post' onclick='postMsg();')
            .alert(style="display:none;") text
            #feed 
                if feed.length > 0 
                    each postID in feed
                        - var post = posts[postID];
                        - var sender = post['sender'];
                        - var content = post['content'];
                        - var isOwner = post['isOwner'];
                        - var isLink = post['isLink'];
                        - var postTime = post['postTime'];
                        - var seenConvo = post['seen'];
                        - var memberNum = nicknames.indexOf(sender);
                        - var viewers = post['viewers'];
                        - var viewerNames = "";
                        each viewerName, index in viewers 
                            - viewerNames += viewerName
                            if index < viewers.length - 1
                                - viewerNames +=  ", ";
                        if viewerNames.length > 0
                            - viewerNames = "Viewed by: " + viewerNames; 
                        .post(data= postID)
                            .sender(class='user'+ memberNum)
                                if isOwner === true 
                                    .dropdown
                                        a#postSettings(data-toggle="dropdown" title="Settings" href="#")
                                        ul#postDropdown.dropdown-menu(role="menu" aria-labelledby="dLabel")
                                            li(role="presentation")
                                                a#editOption(role="menuitem" tabindex="-1" data-toggle="modal" data-target="#editPost" href="#")
                                                    span(class="glyphicon glyphicon-pencil")
                                                    span.postOption Edit post
                                            li(role="presentation")
                                                a#removeOption(role="menuitem" tabindex="-1" data-toggle="modal" data-target="#removePost" href="#") 
                                                    span(class="glyphicon glyphicon-trash")
                                                    span.postOption Remove Post 

                                span
                                    if sphereMap[currentSphere].type != "Main"
                                        .postername=sender 
                                    .time=moment(postTime).format("MMM Do, h:mm a")
                            .postContent
                                if isLink === true
                                        if content["image"] === ""
                                            a.post_link(target='_blank' href=content['url'])
                                                if content['thumbnail'] === ""
                                                    span.title(style='float:none; padding:5px;')=content['title']
                                                else
                                                    img(src=content['thumbnail'])
                                                    span.title=content['title'] 
                                        else
                                            a.post_image(target='_blank' href=content['image'])
                                                img(src=content['image'])
                                                span.title.image=content['title']
                                else
                                    a.textPost
                                        =content['title']
                            .postButtons  
                                ul
                                    if sphereMap[currentSphere].type != "Main"
                                        li(style="float:left;")
                                            a#viewedIcon(href='#' data-toggle="showViewers" data-placement="top" title=viewerNames)
                                                if viewers.length > 0
                                                    span.viewedNum
                                                        =viewers.length 
                                    li
                                        a#shareIcon(href='#' title="Share Link" data-toggle="modal" data-target="#sharePost")   
                                    if sphereMap[currentSphere].type != "Main"
                                        li
                                            a#saveIcon(href='#' title="Save Link")   
                                        li
                                            a(href='#' title="Comments")    
                                                if seenConvo === false 
                                                    a#unseenChat(href='#' title="Comments")  
                                                else 
                                                    a#chatIcon(href='#' title="Comments")
        #messageBox.controls(style="display:none")
            textarea#messageInput(class="form-control" placeholder="Enter a message...")
            input#send(type='button' class="btn btn-primary" value='send')
        #dropperControl.btn-group
            button.btn.btn-default(type="radio" onclick="")
                span.glyphicon.glyphicon-align-center
            button.btn.btn-default(type="radio")
                span.glyphicon.glyphicon-picture
            button.btn.btn-default(type="radio")
                span.glyphicon.glyphicon-link
#shareModal.modal.fade(tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true")
         .modal-dialog
            .modal-content
              .modal-header
                button.close(type="button" data-dismiss="modal" aria-hidden="true") &times;
                h4.modal-title Invite your friends
              
              .modal-body
                label Copy and Paste the link below
                input#inviteLink(class="form-control" placeholder="New Name" value= sphereMap[currentSphere].link readonly="readonly")
#contactList.modal.fade(tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true")
         .modal-dialog
            .modal-content
              .modal-header
                button.close(type="button" data-dismiss="modal" aria-hidden="true") &times;
                h4.modal-title Contacts
              #contactsContent.modal-body
                h5 
                    a#addContact(href="#") Add Contact
                    a#backToContacts(style="display:none;" href="#") Contact List
                #contactListContainer
                    if requesterIds.length > 0
                        p Pending Requests..
                        ul#pendingRequests
                            each requesterId in requesterIds
                                - var requester = requests[requesterId];
                                li(data=requesterId)
                                    span=requester 
                                    a#acceptRequest(href='#') Accept
                                    a#ignoreRequest(href='#') Ignore
                    ul#contactNames
                        each contactId in contactIds
                            - var contact = contacts[contactId];
                            li(data=contactId) 
                                a(href='#')=contact 
                #contactAdding(style="display:none")
                    p Enter the username or email of your new contact
                    input(class="form-control" placeholder="Name or Email")
                    span#contactNotifications(style:"display:none;")
                    .modal-footer
                        button#contactAdd.btn.btn-primary(type="button") Add 
#nameChange.modal.fade(tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true")
 .modal-dialog
    .modal-content
      .modal-header
        button.close(type="button" data-dismiss="modal" aria-hidden="true") &times;
        h4.modal-title New Username  
      
      .modal-body
        input#newName(class="form-control" placeholder="New Name")
      
      .modal-footer
        button#saveName.btn.btn-primary(type="button") Save changes
#nickChange.modal.fade(tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true")
 .modal-dialog
    .modal-content
      .modal-header
        button.close(type="button" data-dismiss="modal" aria-hidden="true") &times;
        h4.modal-title Add a nickname!
      .modal-body
        h5.modal-title Please enter a nickname
        input#newNick(class="form-control" placeholder="(Mom, Dad, Heisenberg, Flynn)")
        h5.modal-title Where would you like it seen?
        ul#nickAddingSpheres
            each sphereID, i in sphereIDs 
                - var sphereName = sphereMap[sphereID].name;
                - var sphereNick = sphereMap[sphereID].nickname;
                li(data=sphereID)
                    a#selectingSphere
                    =sphereName 
                    = ' '
                    span 
                        if sphereNick.length > 0
                            - sphereNick = "(" + sphereNick + ")";
                        else
                            - sphereNick = "(No Nickname)";
                        =sphereNick
      .modal-footer
        button#saveNick.btn.btn-primary(type="button") Apply 
#sphereDialog.modal.fade(tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true")
 .modal-dialog
    .modal-content
      .modal-header
        button.close(type="button" data-dismiss="modal" aria-hidden="true") &times;
        h4.modal-title Create a sphere
      
      .modal-body
        input#sphereName(class="form-control" placeholder="Sphere name")
      
      .modal-footer
        button#saveSphere.btn.btn-primary(type="button") Save changes
#deleteSphere.modal.fade(tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true")
 .modal-dialog
    .modal-content
      .modal-header
        button.close(type="button" data-dismiss="modal" aria-hidden="true") &times;
        h4.modal-title Select a Sphere to Delete
      
      .modal-body
            ul#deletableSpheres
                each sphereID, i in sphereIDs
                    if sphereMap[sphereID].isOwner === true && sphereMap[sphereID].type != "Main"
                        - var sphereName = sphereMap[sphereID].name;
                        li(data=sphereID)
                            a(href='#')=sphereName
                           
          
      .modal-footer
        button#saveSphere.btn.btn-primary(type="button") Save changes
#sharePost.modal.fade(tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true")
 .modal-dialog
    .modal-content
      .modal-header
        button.close(type="button" data-dismiss="modal" aria-hidden="true") &times;
        h4.modal-title Share With..
        ul#shareSelection(class="nav nav-tabs" role="tablist")
            li.active
                a(href='#' onclick='showSphereList();') Spheres
            li  
                a(href='#' onclick='showContactList();') Contacts
          
        #shareRecipients.modal-body
            ul#shareSpheres
                each sphereID, i in sphereIDs 
                    if sphereMap[sphereID].type == "Group"
                        - var sphereName = sphereMap[sphereID].name;
                        li(data=sphereID)
                            a(href='#')=sphereName
            ul#shareContacts(style='display:none;')
                each contactId in contactIds
                    - var contact = contacts[contactId];
                        li(data=contactId) 
                            a(href='#')=contact 


#editPost.modal.fade(tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true")
 .modal-dialog
    .modal-content
      .modal-header
        button.close(type="button" data-dismiss="modal" aria-hidden="true") &times;
        h4.modal-title Edit this post 
      
      .modal-body
        textarea#editContent(class="form-control" )
      
      .modal-footer
        button#saveEdits.btn.btn-primary(type="button") Save changes
#removePost.modal.fade(tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true")
 .modal-dialog
    .modal-content
      .modal-header
        button.close(type="button" data-dismiss="modal" aria-hidden="true") &times;
        h4.modal-title Are you sure you want to remove this post?  
      
      .modal-body
        button#acceptDeletion.btn.btn-primary(type="button") Yes
        button#rejectDeletion.btn.btn-primary(type="button") No

#preload
    img(src="/img/settings_hover.png")
    img(src="/img/post_settings_hover.png")
    img(src="/img/loading.gif")
    img(src="/img/share_post_hover.png")
    img(src="/img/sphere_add_hover.png")
    img(src="favicon.png")
script.
    // harvest all sphere related data for client tracking/use 
    sphereData = !{JSON.stringify(data)};
    username = sphereData.username;
    nickname = sphereData.nickname;
    nicknames = sphereData.nicknames;
    sphereMap = sphereData.sphereMap;
    currentSphere = sphereData.currentSphere;
    totalUpdates = sphereData.totalUpdates;
    sphereIDs = sphereData.sphereIDs;
    sphereID = sphereMap[currentSphere].id;
    sphereLink = sphereMap[currentSphere].link;
    posts = sphereData.posts; 
    feed = sphereData.feed;
    viewedIcon = "<a id='viewedIcon' href='#' data-toggle='tooltip' data-placement='top' title=''></a>";
    shareIcon = "<a id='shareIcon' href='#' data-toggle='modal' data-target='#sharePost' title='Share'></a>";
    saveIcon = "<a id='saveIcon' href='#'></a>";
script.
    $(document).ready(function(){
        $.getScript('/js/chat_bindings.js')
        $.getScript('/js/lib/jquery.slimscroll.min.js')
            .done(function(){
               $.getScript('/js/main.js'); 
            }); 
    });
  
